<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Grade Engine & Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #050505; color: #e5e5e5; }
        .glass { background: #111; border: 1px solid #222; }
        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; height: 6px; border-radius: 5px; background: #222; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #6366f1; cursor: pointer; margin-top: -6px; border: 2px solid #000; box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #333; border-radius: 5px; }
        
        .score-box { background: #0f0f0f; border: 1px solid #222; border-radius: 8px; transition: 0.2s; }
        .score-box:focus-within { border-color: #6366f1; background: #151515; }
        
        .input-base { background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 0.375rem; width: 100%; outline: none; transition: 0.2s; padding: 0.5rem; font-size: 0.875rem; }
        .input-base:focus { border-color: #6366f1; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 relative">

    <div id="app" class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">Grade Engine</h1>
                <p class="text-gray-400 text-sm mt-1">Real-time CGPA Predictor & Course Manager</p>
            </div>
            <div class="flex gap-3 w-full md:w-auto">
                 <select v-model="selectedCourseId" @change="loadCourse" class="bg-[#1a1a1a] border border-gray-800 rounded-lg px-4 py-2 text-sm text-gray-300 outline-none w-full md:w-64 shadow-lg">
                    <optgroup label="Foundation">
                        <option v-for="c in courses.filter(x=>x.level==='Foundation')" :key="c.id" :value="c.id">{{ c.subject }}</option>
                    </optgroup>
                    <optgroup label="Diploma">
                        <option v-for="c in courses.filter(x=>x.level==='Diploma')" :key="c.id" :value="c.id">{{ c.subject }}</option>
                    </optgroup>
                    <optgroup label="Degree">
                        <option v-for="c in courses.filter(x=>x.level==='Degree')" :key="c.id" :value="c.id">{{ c.subject }}</option>
                    </optgroup>
                </select>
                
                <button @click="openEditModal" class="bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3 py-2 border border-gray-700 transition" title="Edit Course Config">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
                 <button @click="openAddModal" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-3 py-2 transition shadow-lg shadow-indigo-500/20" title="Add New Course">
                    <i class="fa-solid fa-plus"></i>
                </button>
                <button @click="saveFile" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-3 py-2 transition shadow-lg shadow-indigo-500/20" title="Save All Changes">
                    <i class="fa-solid fa-save"></i>
                </button>
            </div>
        </header>

        <div v-if="currentCourse" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left: Inputs -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Dynamic Inputs Grid -->
                <div class="glass p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
                            Score Components
                        </h3>
                         <button @click="resetScores" class="text-xs text-gray-500 hover:text-white transition">Reset</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div v-for="inp in currentCourse.inputs" :key="inp.id" class="relative group">
                            
                            <div class="flex justify-between mb-2">
                                <label class="text-sm text-gray-400 font-medium group-hover:text-indigo-300 transition">{{ inp.label }}</label>
                                <span class="font-mono text-sm font-bold text-white">{{ scores[inp.id] }} <span class="text-gray-600 text-xs text-normal">/{{ inp.max }}</span></span>
                            </div>
                            
                            <!-- Slider + Input Combo -->
                            <div class="flex items-center gap-4">
                                <input type="range" v-model.number="scores[inp.id]" :min="0" :max="inp.max" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                
                                <input type="number" v-model.number="scores[inp.id]" :min="0" :max="inp.max" class="w-20 bg-[#151515] border border-gray-700 rounded-md px-2 py-1 text-sm text-center focus:border-indigo-500 outline-none">
                            </div>

                            <!-- Weight Badge -->
                            <div v-if="inp.weight" class="absolute -top-1 -right-2 text-[10px] text-gray-600 font-mono opacity-0 group-hover:opacity-100 transition">
                                Weight: {{ Math.round(inp.weight * 100) }}%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grading Formula Reference -->
                 <div class="glass p-6 rounded-2xl relative overflow-hidden group">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Applied Formula</h3>
                    <div class="bg-[#0a0a0a] p-3 rounded-lg border border-gray-800 font-mono text-xs text-gray-400 leading-relaxed overflow-x-auto whitespace-pre-wrap">
                        {{ currentCourse.formula }}
                    </div>
                 </div>

            </div>

            <!-- Right: Result -->
            <div class="lg:col-span-1">
                <div class="sticky top-6">
                    <div class="glass p-8 rounded-3xl flex flex-col items-center justify-center text-center shadow-2xl shadow-indigo-500/10 border-indigo-500/20 relative overflow-hidden">
                        
                        <!-- Background Glow -->
                        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-indigo-900/10 pointer-events-none"></div>

                        <div class="relative z-10">
                            <div class="w-40 h-40 rounded-full flex items-center justify-center text-7xl font-black mb-4 relative mx-auto transition-all duration-500" :class="gradeColor">
                                {{ finalGrade }}
                                <div class="absolute inset-0 rounded-full border-[6px] opacity-20 border-current animate-pulse"></div>
                                <div class="absolute inset-0 rounded-full border-[6px] opacity-60 border-t-current animate-spin" style="animation-duration: 3s;"></div>
                            </div>
                            
                            <div class="text-4xl font-bold text-white mb-1 transition-all">{{ formatNum(finalScore) }}<span class="text-lg text-gray-500">%</span></div>
                            <div class="text-xs text-gray-500 uppercase tracking-widest mb-8">Total Weighted Score</div>

                            <!-- Status -->
                            <div class="flex items-center justify-center gap-2 mb-6">
                                <span class="px-3 py-1 rounded-full text-xs font-bold border" :class="passStatus ? 'bg-green-500/10 border-green-500/30 text-green-400' : 'bg-red-500/10 border-red-500/30 text-red-400'">
                                    {{ passStatus ? 'PASSED' : 'FAILED' }}
                                </span>
                            </div>
                            
                            <!-- Mini Graph/Bars for Components -->
                             <div class="w-full space-y-2 mt-4 pt-4 border-t border-gray-800">
                                <div v-for="inp in currentCourse.inputs.filter(x => x.weight)" :key="inp.id" class="flex items-center gap-2 text-xs">
                                    <span class="w-16 text-right text-gray-500 truncate">{{ inp.id }}</span>
                                    <div class="flex-1 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-indigo-500" :style="{ width: ((scores[inp.id]/inp.max)*100) + '%' }"></div>
                                    </div>
                                    <span class="w-8 text-right text-gray-400">{{ scores[inp.id] }}</span>
                                </div>
                             </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Edit Modal -->
        <div v-if="editingCourse" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
            <div class="bg-[#111] border border-gray-800 rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
                <!-- Modal Header -->
                <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-[#0d0d0d]">
                    <h2 class="text-xl font-bold text-white">{{ isNew ? 'Create New Grading Schema' : 'Edit Grading Schema' }}</h2>
                    <div class="flex gap-2">
                        <button @click="deleteCourse" v-if="!isNew" class="text-red-500 hover:text-red-400 px-3 py-1 text-sm font-medium">Delete</button>
                        <button @click="editingCourse = null" class="text-gray-400 hover:text-white px-3 py-1 text-sm font-medium">Cancel</button>
                        <button @click="saveCourse" class="bg-indigo-600 hover:bg-indigo-500 text-white rounded px-4 py-2 text-sm font-bold shadow-lg shadow-indigo-500/20">Save Schema</button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="flex-1 overflow-y-auto p-8 bg-[#0a0a0a]">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-2">Subject Name</label>
                            <input v-model="editingCourse.subject" class="input-base" placeholder="e.g. Mathematics II">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-2">Course Level</label>
                            <select v-model="editingCourse.level" class="input-base">
                                <option>Foundation</option>
                                <option>Diploma</option>
                                <option>Degree</option>
                            </select>
                        </div>
                         <div>
                            <label class="block text-xs font-medium text-gray-500 mb-2">Unique ID (e.g. ma2)</label>
                            <input v-model="editingCourse.id" class="input-base" :disabled="!isNew">
                        </div>
                    </div>

                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest">Grading Components (Inputs)</h3>
                            <button @click="addInput" class="text-indigo-400 hover:text-indigo-300 text-xs font-bold">+ Add Component</button>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(inp, idx) in editingCourse.inputs" :key="idx" class="flex gap-3 bg-[#151515] p-3 rounded-lg border border-gray-800 items-start">
                                <div class="w-24">
                                     <label class="text-[10px] text-gray-600 block mb-1">ID (Variable)</label>
                                     <input v-model="inp.id" class="input-base p-1 text-xs font-mono" placeholder="GA">
                                </div>
                                <div class="flex-1">
                                     <label class="text-[10px] text-gray-600 block mb-1">Display Label</label>
                                     <input v-model="inp.label" class="input-base p-1 text-xs" placeholder="Graded Assignments">
                                </div>
                                <div class="w-20">
                                     <label class="text-[10px] text-gray-600 block mb-1">Max Score</label>
                                     <input v-model.number="inp.max" type="number" class="input-base p-1 text-xs">
                                </div>
                                <div class="w-20">
                                     <label class="text-[10px] text-gray-600 block mb-1">Weight</label>
                                     <input v-model.number="inp.weight" type="number" step="0.01" class="input-base p-1 text-xs">
                                </div>
                                <button @click="editingCourse.inputs.splice(idx, 1)" class="text-gray-600 hover:text-red-500 p-2 mt-4"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>

                    <div>
                         <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Calculation Formula (JS Expression)</h3>
                         <p class="text-xs text-gray-600 mb-2">Use the IDs defined above as variables. Example: <code class="bg-[#1a1a1a] px-1 rounded text-gray-400">0.1*GA + 0.3*Q1 + 0.6*F</code></p>
                         <textarea v-model="editingCourse.formula" class="input-base h-24 font-mono text-sm leading-relaxed" placeholder="Enter JavaScript Formula..."></textarea>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    courses: [],
                    selectedCourseId: null,
                    currentCourse: null,
                    scores: {}, // Dynamic object { ID: value }
                    editingCourse: null, // For modal
                    isNew: false
                }
            },
            computed: {
                // Calculate T using the formula string
                result() {
                    if(!this.currentCourse) return { total: 0, grade: 'U', pass: false };

                    // 1. Prepare Variables
                    const context = {};
                    this.currentCourse.inputs.forEach(i => {
                        context[i.id] = this.scores[i.id] || 0;
                    });
                    
                    // 2. Evaluate Formula
                    let T = 0;
                    try {
                        const keys = Object.keys(context);
                        const values = Object.values(context);
                        const calcFn = new Function(...keys, `return ${this.currentCourse.formula}`);
                        T = calcFn(...values);
                    } catch(e) {
                         // console.error("Formula Error", e);
                         T = 0;
                    }

                    // 3. Round T
                    T = Math.min(100, Math.max(0, T)); // Cap at 100

                    // 4. Pass Logic (Simplified General Rule: T >= 40 AND F >= 40% of max F)
                    const finalExam = this.currentCourse.inputs.find(i => i.id === 'F');
                    let hasEndTermCheck = false;
                    if(finalExam) {
                         const fScore = context['F'] || 0;
                         const ratio = fScore / (finalExam.max || 100);
                         if(ratio < 0.4) hasEndTermCheck = true;
                    }
                    
                    let pass = T >= 40;
                    if(hasEndTermCheck) pass = false;

                    // 5. Grade
                    let grade = 'U';
                    if(!pass) grade = 'U';
                    else if(T >= 90) grade = 'S';
                    else if(T >= 80) grade = 'A';
                    else if(T >= 70) grade = 'B';
                    else if(T >= 60) grade = 'C';
                    else if(T >= 50) grade = 'D';
                    else if(T >= 40) grade = 'E';
                    
                    return { total: T, grade, pass };
                },
                finalScore() { return this.result.total; },
                finalGrade() { return this.result.grade; },
                passStatus() { return this.result.pass; },
                gradeColor() {
                    const g = this.finalGrade;
                    if(g === 'S') return 'text-yellow-400';
                    if(g === 'A') return 'text-emerald-400';
                    if(['B','C'].includes(g)) return 'text-blue-400';
                    if(g === 'D') return 'text-orange-400';
                    return 'text-red-500';
                }
            },
            mounted() {
                this.loadCourses();
            },
            methods: {
                async loadCourses() {
                    try {
                        const res = await fetch('./data.json');
                        this.courses = await res.json();
                        if(this.courses.length > 0 && !this.selectedCourseId) {
                            this.selectedCourseId = this.courses[0].id;
                            this.loadCourse();
                        }
                    } catch(e) { console.error(e); }
                },
                loadCourse() {
                    this.currentCourse = this.courses.find(c => c.id === this.selectedCourseId);
                    this.scores = {};
                    if(this.currentCourse) {
                        this.currentCourse.inputs.forEach(inp => {
                            if(inp.id.startsWith('Bonus')) this.scores[inp.id] = 0;
                            else if(inp.id === 'F' || inp.id.includes('Qz') || inp.id.includes('OP')) this.scores[inp.id] = Math.floor(inp.max * 0.7);
                            else this.scores[inp.id] = inp.max;
                        });
                    }
                },
                resetScores() {
                     this.currentCourse.inputs.forEach(inp => {
                        this.scores[inp.id] = 0;
                    });
                },
                formatNum(n) { return (n || 0).toFixed(1); },
                
                // Editor Methods
                openEditModal() {
                    if(!this.currentCourse) return;
                    this.isNew = false;
                    // Deep copy
                    this.editingCourse = JSON.parse(JSON.stringify(this.currentCourse));
                },
                openAddModal() {
                    this.isNew = true;
                    this.editingCourse = {
                        id: 'new_course_' + Date.now(),
                        subject: 'New Subject',
                        level: 'Foundation',
                        inputs: [
                            { id: 'GA', label: 'Graded Assignments', max: 100, weight: 0.1 },
                            { id: 'Q1', label: 'Quiz 1', max: 100, weight: 0.3 },
                            { id: 'F', label: 'End Term', max: 100, weight: 0.6 }
                        ],
                        formula: '0.1*GA + 0.3*Q1 + 0.6*F'
                    };
                },
                addInput() {
                    this.editingCourse.inputs.push({ id: 'X', label: 'New Comp', max: 100, weight: 0 });
                },
                saveCourse() {
                    if(this.isNew) {
                        this.courses.push(this.editingCourse);
                        this.selectedCourseId = this.editingCourse.id; // Switch to new
                    } else {
                        const idx = this.courses.findIndex(c => c.id === this.editingCourse.id);
                        if(idx !== -1) {
                            this.courses[idx] = this.editingCourse;
                            // Update currentView if we edited the active one
                            if(this.currentCourse.id === this.editingCourse.id) {
                                this.loadCourse(); 
                            }
                        }
                    }
                    this.editingCourse = null;
                    // Trigger simple notification or log?
                    // User requested persist only on explicit save generally, but here we update local state.
                },
                deleteCourse() {
                    if(confirm("Are you sure you want to delete this course schema?")) {
                        this.courses = this.courses.filter(c => c.id !== this.editingCourse.id);
                        this.editingCourse = null;
                        if(this.courses.length > 0) {
                            this.selectedCourseId = this.courses[0].id;
                            this.loadCourse();
                        } else {
                            this.currentCourse = null;
                            this.selectedCourseId = null;
                        }
                    }
                },
                async saveFile() {
                    try {
                        if (window.showSaveFilePicker) {
                            const handle = await window.showSaveFilePicker({ suggestedName: 'data.json' });
                            const writable = await handle.createWritable();
                            await writable.write(JSON.stringify(this.courses, null, 2));
                            await writable.close();
                            alert("Configurations saved!");
                        } else {
                            const blob = new Blob([JSON.stringify(this.courses, null, 2)], {type: 'application/json'});
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = 'data.json';
                            a.click();
                        }
                    } catch (e) { console.error(e); }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
